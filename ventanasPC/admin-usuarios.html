<!DOCTYPE html>
<html class="light" lang="es"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin - Usuarios</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#6F5E53","background-light":"#F7F5F2","background-dark":"#211911","brand":"#A0744E"},fontFamily:{display:["Inter","sans-serif"]}}}}</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="assets/app.js"></script>
</head>
<body data-admin-page class="bg-background-light dark:bg-background-dark font-display text-[#2b211b]">
<div class="relative flex min-h-screen w-full flex-col">
  <header class="w-full border-b border-primary/20 bg-white/80 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto h-16 flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <div class="size-6 text-primary"><svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"/></svg></div>
        <h2 class="text-lg font-bold">Makitu Store</h2>
      </div>
      <nav class="hidden md:flex items-center gap-6">
        <a class="text-sm" href="admin-dashboard.html">Dashboard</a>
        <a class="text-sm" href="admin-categorias.html">Categor√≠as</a>
        <a class="text-sm" href="admin-productos.html">Productos</a>
        <a class="text-sm" href="admin-ordenes.html">√ìrdenes</a>
        <a class="px-3 py-1.5 rounded-full bg-primary text-white text-sm font-bold" href="admin-usuarios.html">Usuarios</a>
      </nav>
      <div class="flex items-center gap-2 sm:gap-3 relative">
        <button id="btn-notif" class="relative h-9 w-9 sm:h-10 sm:w-10 flex items-center justify-center rounded-full hover:bg-primary/10"><span class="material-symbols-outlined text-base sm:text-[20px]">notifications</span></button>
        <button id="btn-admin-logout" class="min-w-[110px] sm:min-w-[120px] items-center justify-center rounded-full h-9 sm:h-10 px-3 sm:px-4 border bg-white text-xs sm:text-sm font-bold">Cerrar sesi√≥n</button>
      </div>
    </div>
    <nav class="md:hidden border-t border-primary/10 bg-white/80">
      <div class="max-w-6xl mx-auto grid grid-cols-5 gap-2 px-4 py-2 text-[11px] font-medium text-[#6b5b52]">
        <a href="admin-dashboard.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">leaderboard</span>
          <span>Dashboard</span>
        </a>
        <a href="admin-categorias.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">category</span>
          <span>Categor√≠as</span>
        </a>
        <a href="admin-productos.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">inventory_2</span>
          <span>Productos</span>
        </a>
        <a href="admin-ordenes.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">receipt_long</span>
          <span>√ìrdenes</span>
        </a>
        <a href="admin-usuarios.html" class="flex flex-col items-center gap-0.5 text-primary">
          <span class="material-symbols-outlined text-base">group</span>
          <span>Usuarios</span>
        </a>
      </div>
    </nav>
  </header>
  <main class="container mx-auto px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-black mb-6">Gesti√≥n de Usuarios</h1>
    <div class="flex flex-col md:flex-row md:items-center gap-3 mb-4">
      <div class="flex-1 relative">
        <input id="q" class="w-full h-11 rounded-full border pl-11 pr-4" placeholder="Buscar por nombre o email..."/>
        <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-500">search</span>
      </div>
      <select id="rol" class="h-11 rounded-full border px-3 text-sm">
        <option value="">Todos los roles</option>
        <option value="admin">Admin</option>
        <option value="cliente">Cliente</option>
      </select>
      <button id="btn-nuevo" class="h-11 px-4 rounded-full bg-primary text-white font-bold">+ A√±adir Nuevo Usuario</button>
    </div>
    <div class="rounded-2xl border bg-white overflow-x-auto">
      <div class="min-w-[680px]">
        <div class="grid grid-cols-6 gap-2 px-3 py-2 bg-gray-50 text-xs sm:text-sm font-medium"><span>ID</span><span>Nombre</span><span>Email</span><span>Tel√©fono</span><span>Rol</span><span>Acciones</span></div>
        <div id="rows" class="divide-y"></div>
      </div>
    </div>
    <div id="pager" class="mt-4 flex items-center justify-center gap-2"></div>
  </div>
  </main>
</div>
<script>
async function requireAdmin(){
  const ok = await Auth.requireAuth(); if(!ok) return false;
  try{ if(sessionStorage.getItem('is_admin_flag')==='1'){ return true; } }catch{}
  try{
    const { data:rpcVal, error:rpcErr } = await supabaseClient.rpc('fn_is_admin');
    if(!rpcErr && rpcVal===true){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    if(!rpcErr && rpcVal===false){ location.href='home.html'; return false; }
  }catch{}
  try{
    const s = await Auth.getSession(); const uid = s?.user?.id;
    const { data, error } = await supabaseClient.from('usuarios').select('es_admin').eq('id', uid).maybeSingle();
    if(error){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    if(data?.es_admin){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    location.href='home.html'; return false;
  }catch{ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
}
let state={page:1,size:10,q:'',rol:''};
function badgeRol(isAdmin){ const cls=isAdmin?'bg-amber-200 text-amber-900':'bg-gray-200 text-gray-800'; const label=isAdmin?'Admin':'Cliente'; return `<span class='px-2 py-1 rounded-full text-xs ${cls}'>${label}</span>`; }
async function load(){
  const { data } = await supabaseClient.rpc('fn_admin_users_list');
  const filtered=(data||[]).filter(u=>!state.q || ((u.nombre||'').toLowerCase().includes(state.q)|| (u.email||'').toLowerCase().includes(state.q))).filter(u=>!state.rol || (state.rol==='admin'?u.es_admin:!u.es_admin));
  const start=(state.page-1)*state.size; const pageItems=filtered.slice(start, start+state.size);
  document.getElementById('rows').innerHTML = pageItems.map(u=>`<div class='grid grid-cols-6 items-center gap-2 px-3 py-2'>
    <span class='text-sm'>${u.id?.slice?.(0,8)||u.id}</span>
    <span class='text-sm'>${u.nombre||''}</span>
    <span class='text-sm max-w-[220px] truncate break-all'>${u.email||''}</span>
    <span class='text-sm whitespace-nowrap'>${u.telefono||''}</span>
    <span>${badgeRol(!!u.es_admin)}</span>
    <span class='flex items-center gap-2'>
      <button class='text-primary' data-edit='${u.id}'>‚úé</button>
      <button class='text-red-600' data-del='${u.id}'>üóë</button>
    </span>
  </div>`).join('');
  const totalPages=Math.max(1, Math.ceil(filtered.length/state.size));
  const pager=document.getElementById('pager'); pager.innerHTML='';
  const prev=document.createElement('button'); prev.textContent='‚Äπ'; prev.className='px-3 h-9 rounded-full border bg-white text-sm'; prev.disabled=state.page<=1; prev.onclick=()=>{state.page--; load();}; pager.append(prev);
  for(let i=1;i<=totalPages;i++){ const b=document.createElement('button'); b.textContent=String(i); b.className='w-9 h-9 rounded-full text-sm '+(i===state.page?'bg-amber-400 text-white':'border bg-white'); b.onclick=()=>{state.page=i; load();}; pager.append(b); if(i>=6 && i<totalPages){ const dots=document.createElement('span'); dots.textContent='‚Ä¶'; dots.className='px-2'; pager.append(dots); i=totalPages-1; } }
  const next=document.createElement('button'); next.textContent='‚Ä∫'; next.className='px-3 h-9 rounded-full border bg-white text-sm'; next.disabled=state.page>=totalPages; next.onclick=()=>{state.page++; load();}; pager.append(next);
}
function bind(){
  document.getElementById('rol').addEventListener('change',()=>{ state.rol=(document.getElementById('rol').value||'').toLowerCase(); state.page=1; load();});
  document.getElementById('q').addEventListener('input', e=>{ state.q=(e.target.value||'').trim().toLowerCase(); state.page=1; load();});
  document.getElementById('rows').addEventListener('click', async (e)=>{
    const ed=e.target.closest('[data-edit]'); const del=e.target.closest('[data-del]');
    if(ed){ const id=ed.getAttribute('data-edit'); const { data:u } = await supabaseClient.from('usuarios').select('*').eq('id', id).single();
      const nombre=prompt('Nombre', u?.nombre||''); const tel=prompt('Tel√©fono', u?.telefono||''); const admin=confirm('¬øMarcar como Admin? Aceptar = S√≠ / Cancelar = No');
      if(nombre!==null){ await supabaseClient.from('usuarios').upsert({ id, nombre, telefono: tel||null, es_admin: admin }); load(); }
    }
    if(del){ const id=del.getAttribute('data-del'); if(confirm('¬øEliminar registro de usuario? Esto no elimina la cuenta de autenticaci√≥n.')){ await supabaseClient.from('usuarios').delete().eq('id', id); load(); }}
  });
  document.getElementById('btn-nuevo').addEventListener('click', async ()=>{
    const email=prompt('Email del usuario (ya registrado)'); if(!email) return;
    const { data:auth } = await supabaseClient.auth.getUser(); // no tenemos admin API; solo creamos/actualizamos fila si ya existe
    // Intentar localizar por email
    const { data:found } = await supabaseClient.from('usuarios').select('id').eq('email', email).maybeSingle();
    let id = found?.id; if(!id){ alert('Primero el usuario debe registrarse por login.'); return; }
    const nombre=prompt('Nombre'); const tel=prompt('Tel√©fono'); const admin=confirm('¬øEs Admin? Aceptar = S√≠ / Cancelar = No');
    await supabaseClient.from('usuarios').upsert({ id, email, nombre: nombre||null, telefono: tel||null, es_admin: admin }); load();
  });
}
window.addEventListener('DOMContentLoaded', async()=>{ if(await requireAdmin()){ bind(); load(); }});
</script>
</body></html>
