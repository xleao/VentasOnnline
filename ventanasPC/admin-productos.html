<!DOCTYPE html>
<html class="light" lang="es"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin - Productos</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#6F5E53","background-light":"#F7F5F2","background-dark":"#211911","brand":"#A0744E"},fontFamily:{display:["Inter","sans-serif"]}}}}</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="assets/app.js"></script>
</head>
<body data-admin-page class="bg-background-light dark:bg-background-dark font-display text-[#2b211b]">
<div class="relative flex min-h-screen w-full flex-col">
  <header class="w-full border-b border-primary/20 bg-white/80 backdrop-blur-sm">
    <div class="max-w-6xl mx-auto h-16 flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <div class="size-6 text-primary"><svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"/></svg></div>
        <h2 class="text-lg font-bold">Makitu Store</h2>
      </div>
      <nav class="hidden md:flex items-center gap-6">
        <a class="text-sm" href="admin-dashboard.html">Dashboard</a>
        <a class="text-sm" href="admin-categorias.html">Categor√≠as</a>
        <a class="px-3 py-1.5 rounded-full bg-primary text-white text-sm font-bold" href="admin-productos.html">Productos</a>
        <a class="text-sm" href="admin-ordenes.html">√ìrdenes</a>
        <a class="text-sm" href="admin-usuarios.html">Usuarios</a>
      </nav>
      <div class="flex items-center gap-2 sm:gap-3 relative">
        <button id="btn-notif" class="relative h-9 w-9 sm:h-10 sm:w-10 flex items-center justify-center rounded-full hover:bg-primary/10"><span class="material-symbols-outlined text-base sm:text-[20px]">notifications</span></button>
        <button id="btn-admin-logout" class="min-w-[110px] sm:min-w-[120px] items-center justify-center rounded-full h-9 sm:h-10 px-3 sm:px-4 border bg-white text-xs sm:text-sm font-bold">Cerrar sesi√≥n</button>
      </div>
    </div>
    <nav class="md:hidden border-t border-primary/10 bg-white/80">
      <div class="max-w-6xl mx-auto grid grid-cols-5 gap-2 px-4 py-2 text-[11px] font-medium text-[#6b5b52]">
        <a href="admin-dashboard.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">leaderboard</span>
          <span>Dashboard</span>
        </a>
        <a href="admin-categorias.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">category</span>
          <span>Categor√≠as</span>
        </a>
        <a href="admin-productos.html" class="flex flex-col items-center gap-0.5 text-primary">
          <span class="material-symbols-outlined text-base">inventory_2</span>
          <span>Productos</span>
        </a>
        <a href="admin-ordenes.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">receipt_long</span>
          <span>√ìrdenes</span>
        </a>
        <a href="admin-usuarios.html" class="flex flex-col items-center gap-0.5">
          <span class="material-symbols-outlined text-base">group</span>
          <span>Usuarios</span>
        </a>
      </div>
    </nav>
  </header>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-black">Gesti√≥n de Productos</h1>
        <button id="btn-new" type="button" class="h-10 px-4 rounded-full bg-primary text-white text-sm font-bold">+ Nuevo Producto</button>
      </div>
      <div class="grid grid-cols-1 gap-6">
        <div>
          <div class="rounded-2xl border bg-white p-4 shadow-sm mb-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div><label class="text-xs text-gray-500">Categor√≠a</label><select id="f-cat" class="mt-1 h-10 rounded-lg border px-3 text-sm w-full"></select></div>
              <div><label class="text-xs text-gray-500">Subcategor√≠a</label><select id="f-sub" class="mt-1 h-10 rounded-lg border px-3 text-sm w-full"><option value="">Todas</option></select></div>
              <div class="relative"><label class="text-xs text-gray-500">&nbsp;</label><input id="f-q" class="mt-1 h-10 rounded-full border pl-10 pr-4 text-sm w-full" placeholder="Buscar por nombre..."/><span class="material-symbols-outlined absolute left-3 top-3 text-gray-500">search</span></div>
              <div><label class="text-xs text-gray-500">Estado</label><select id="f-status" class="mt-1 h-10 rounded-lg border px-3 text-sm w-full"><option value="">Todos</option><option value="1">Activos</option><option value="0">Inactivos</option></select></div>
            </div>
            <div class="mt-2 text-right"><button id="f-clear" class="text-sm text-gray-600 hover:underline">Limpiar Filtros</button></div>
          </div>
          <div class="rounded-2xl border bg-white overflow-x-auto">
            <div class="sm:min-w-[680px]">
              <div class="hidden sm:grid grid-cols-6 gap-2 px-3 py-2 bg-gray-50 text-xs sm:text-sm font-medium"><span class="col-span-2">Producto</span><span>Precio</span><span>Stock</span><span>Activo</span><span>Acciones</span></div>
              <div id="prod-rows" class="divide-y"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<!-- Modal Nuevo/Editar Producto -->
<div id="prod-modal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-start justify-center p-4 overflow-y-auto">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-lg border mt-10 mb-10">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <h3 id="pm-title" class="font-bold">Nuevo Producto</h3>
        <button id="pm-close" class="h-8 w-8 rounded-full hover:bg-gray-100 flex items-center justify-center"><span class="material-symbols-outlined">close</span></button>
      </div>
      <div class="p-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-3">
            <label class="text-sm">Nombre del producto
              <input id="p-nombre" class="mt-1 h-10 rounded-lg border px-3" placeholder="Ej: Camiseta de algod√≥n"/>
            </label>
            <label class="text-sm">Descripci√≥n
              <textarea id="p-desc" class="mt-1 rounded-lg border px-3 h-28" placeholder="Detalles del producto..."></textarea>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="text-sm">Precio
                <input id="p-precio" type="number" step="0.01" class="mt-1 h-10 w-full rounded-lg border px-3" placeholder="0.00"/>
              </label>
              <label class="text-sm">Stock
                <input id="p-stock" type="number" class="mt-1 h-10 w-full rounded-lg border px-3" placeholder="0"/>
              </label>
            </div>
            <label class="text-sm">Subcategor√≠a
              <select id="p-sub" class="mt-1 h-10 rounded-lg border px-3"></select>
            </label>
          </div>
          <div class="space-y-3">
            <div class="text-sm flex items-center justify-between"><span>Imagen del producto</span><span class="text-xs text-gray-500">Bucket: <code>imagenes</code></span></div>
            <div class="rounded-xl border bg-gray-50 p-3 flex flex-col items-center justify-center gap-3">
              <div class="w-full aspect-video max-h-56 rounded-lg overflow-hidden bg-white border">
                <img id="p-preview" alt="Vista previa" class="w-full h-full object-cover hidden"/>
                <div id="p-prev-ph" class="w-full h-full flex items-center justify-center text-gray-400 text-sm">Sin imagen</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="p-change-img" type="button" class="h-9 px-3 rounded-lg border bg-white text-sm">Cambiar imagen</button>
                <button id="p-remove-img" type="button" class="h-9 px-3 rounded-lg border text-sm">Quitar</button>
              </div>
              <input id="p-file" type="file" accept="image/*" class="hidden"/>
            </div>
          </div>
        </div>
      </div>
      <div class="px-5 py-4 border-t flex items-center justify-end gap-3">
        <button id="p-cancel" class="h-10 px-4 rounded-lg border">Cancelar</button>
        <button id="p-save" class="h-10 px-4 rounded-lg bg-primary text-white font-bold">Guardar Producto</button>
      </div>
    </div>
  </div>
</div>
<script>
async function requireAdmin(){
  const ok = await Auth.requireAuth(); if(!ok) return false;
  try{ if(sessionStorage.getItem('is_admin_flag')==='1'){ return true; } }catch{}
  try{
    const { data:rpcVal, error:rpcErr } = await supabaseClient.rpc('fn_is_admin');
    if(!rpcErr && rpcVal===true){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    if(!rpcErr && rpcVal===false){ location.href='home.html'; return false; }
  }catch{}
  try{
    const s=await Auth.getSession(); const uid=s?.user?.id;
    const { data, error } = await supabaseClient.from('usuarios').select('es_admin').eq('id',uid).maybeSingle();
    if(error){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    if(data?.es_admin){ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
    location.href='home.html'; return false;
  }catch{ try{ sessionStorage.setItem('is_admin_flag','1'); }catch{} return true; }
}
async function loadFilters(){
  const { data:cats } = await supabaseClient.rpc('fn_admin_cats_root');
  const { data:subs } = await supabaseClient.rpc('fn_admin_cats_all_subs');
  const fcat=document.getElementById('f-cat'); const fsub=document.getElementById('f-sub'); const psub=document.getElementById('p-sub'); const fstatus=document.getElementById('f-status');
  fcat.innerHTML = `<option value="">Todas</option>` + (cats||[]).map(c=>`<option value='${c.id}'>${c.nombre}</option>`).join('');
  psub.innerHTML = (subs||[]).map(s=>`<option value='${s.id}'>${s.nombre}</option>`).join('');
  fcat.addEventListener('change',()=>{ const id=fcat.value; fsub.innerHTML = `<option value=\"\">Todas</option>` + (subs||[]).filter(s=>!id || String(s.parent_id)===String(id)).map(s=>`<option value='${s.id}'>${s.nombre}</option>`).join(''); });
  document.getElementById('f-clear').addEventListener('click', ()=>{ fcat.value=''; fsub.innerHTML = `<option value=\"\">Todas</option>` + (subs||[]).map(s=>`<option value='${s.id}'>${s.nombre}</option>`).join(''); document.getElementById('f-q').value=''; if(fstatus) fstatus.value=''; loadProducts(); });
}
async function loadProducts(){
  const cat=document.getElementById('f-cat').value; const sub=document.getElementById('f-sub').value; const q=document.getElementById('f-q').value.trim().toLowerCase(); const status=document.getElementById('f-status')?.value||'';
  const { data } = await supabaseClient.rpc('fn_admin_products_list', {
    p_cat_id: cat? Number(cat) : null,
    p_sub_id: sub? Number(sub) : null,
    p_active: status==='' ? null : (status==='1')
  });
  const rows=document.getElementById('prod-rows');
  rows.innerHTML=(data||[]).filter(p=>!q || (p.nombre||'').toLowerCase().includes(q)).map(p=>`
  <div class='grid grid-cols-1 sm:grid-cols-6 items-center gap-3 px-3 py-3' data-row='${p.id}'>
    <div class='flex items-center gap-3 sm:col-span-2'>
      <button type='button' class='w-10 h-10 rounded-lg overflow-hidden bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary/60' data-img-full='${p.imagen_url||''}'>
        <img src='${p.imagen_url||''}' class='w-full h-full object-cover'/>
      </button>
      <div class='min-w-0'>
        <p class='font-medium text-sm sm:text-base truncate'>${p.nombre}</p>
        <p class='text-[11px] text-gray-500'>ID: ${p.id}</p>
      </div>
    </div>
    <div class='text-xs sm:text-sm sm:col-span-1'>S/ ${(Number(p.precio)||0).toFixed(2)}</div>
    <div class='sm:col-span-1'>
      <div class='inline-flex items-center gap-2 rounded-full bg-gray-50 px-2 py-1 border'>
        <button title='Disminuir' class='h-7 w-7 flex items-center justify-center rounded-full border text-sm' data-stock-dec='${p.id}'>-</button>
        <span data-stock='${p.id}' class='min-w-[24px] text-center font-medium'>${p.stock||0}</span>
        <button title='Aumentar' class='h-7 w-7 flex items-center justify-center rounded-full border text-sm' data-stock-inc='${p.id}'>+</button>
      </div>
    </div>
    <div class='sm:col-span-1'>
      <label class='relative inline-flex items-center cursor-pointer'>
        <input type='checkbox' class='sr-only peer' ${p.activo?'checked':''} data-toggle='${p.id}'>
        <div class='w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[" "] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500 relative'></div>
      </label>
    </div>
    <div class='flex items-center gap-3 justify-end sm:col-span-1'>
      <button class='text-primary' title='Editar' data-edit='${p.id}'><span data-edit='${p.id}'>‚úé</span></button>
      <button class='text-red-600' title='Eliminar' data-del='${p.id}'>üóë</button>
    </div>
  </div>`).join('');
}
function bind(){
  ['f-cat','f-sub','f-q','f-status'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', loadProducts); el.addEventListener('change', loadProducts); }});
  document.getElementById('prod-rows').addEventListener('click', async (e)=>{
    const t=e.target; const del=t.closest('[data-del]'); const tog=t.closest('[data-toggle]'); const ed=t.closest('[data-edit]');
    const imgBtn=t.closest('[data-img-full]');
    const inc=t.closest('[data-stock-inc]'); const dec=t.closest('[data-stock-dec]');
    if(del){
      const id=Number(del.getAttribute('data-del'));
      if(confirm('¬øEliminar producto?')){
        const { error } = await supabaseClient.rpc('fn_admin_delete_product', { p_id: id });
        if(error){ console.error('delete product error', error); alert(error.message || 'No se pudo eliminar el producto'); }
        else { loadProducts(); }
      }
    }
    if(imgBtn){
      const url = imgBtn.getAttribute('data-img-full');
      if(url){
        const overlay=document.getElementById('img-lightbox');
        const img=document.getElementById('img-lightbox-img');
        if(overlay && img){
          img.src=url;
          overlay.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
        }
      }
    }
    if(tog){ const id=Number(tog.getAttribute('data-toggle')); const { data:p } = await supabaseClient.from('productos').select('activo').eq('id', id).single(); await supabaseClient.from('productos').update({ activo: !p.activo }).eq('id', id); loadProducts(); }
    if(ed){
      e.preventDefault();
      const raw = t.getAttribute('data-edit') || ed.getAttribute('data-edit');
      const id = Number(raw);
      if(Number.isNaN(id) || !id){ console.warn('Editar producto: id inv√°lido', { raw, id }); return; }
      await openProdModal(id);
    }
    // actualizar stock inline
    if(inc || dec){
      const id = Number((inc||dec).getAttribute(inc?'data-stock-inc':'data-stock-dec'));
      const span = document.querySelector(`[data-stock="${id}"]`);
      if(!span) return;
      const cur = Number(span.textContent||'0') || 0;
      const next = inc ? cur + 1 : Math.max(0, cur - 1);
      span.textContent = String(next);
      try{
        const { error } = await supabaseClient.rpc('fn_admin_update_product_stock', { p_id: id, p_stock: next });
        if(error){ console.error('update stock error', error); span.textContent = String(cur); alert('No se pudo actualizar el stock'); }
      }catch(err){ console.error('update stock exception', err); span.textContent = String(cur); alert('No se pudo actualizar el stock'); }
    }
  });
  // Modal open/close
  let editingProductId=null; let prodRemoveImg=false;
  async function openProdModal(productId=null){
    editingProductId = productId;
    prodRemoveImg=false;
    document.getElementById('prod-modal').classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    const title=document.getElementById('pm-title');
    const name=document.getElementById('p-nombre');
    const desc=document.getElementById('p-desc');
    const precio=document.getElementById('p-precio');
    const stock=document.getElementById('p-stock');
    const sub=document.getElementById('p-sub');
    const fileIn=document.getElementById('p-file');
    const prev=document.getElementById('p-preview');
    const phEl=document.getElementById('p-prev-ph');
    fileIn.value='';
    prev.removeAttribute('src'); prev.classList.add('hidden'); phEl.classList.remove('hidden');
    if(productId){
      console.debug('Abriendo modal edici√≥n producto', productId);
      title.textContent='Editar Producto';
      const { data:p, error } = await supabaseClient.rpc('fn_admin_product_by_id', { p_id: productId });
      if(error||!p){ console.error('Error cargando producto', error); alert('No se pudo cargar el producto'); return; }
      name.value=p.nombre||'';
      desc.value=p.descripcion||'';
      precio.value = p.precio !== undefined && p.precio !== null ? String(p.precio) : '';
      stock.value = p.stock !== undefined && p.stock !== null ? String(p.stock) : '';
      // Seleccionar subcategor√≠a; si no existe en el combo, crear una opci√≥n temporal
      const subId = p.categoria_id ? String(p.categoria_id) : '';
      let opt = Array.from(sub.options).find(o=>o.value===subId);
      if(!opt && subId){
        const { data:sc } = await supabaseClient.rpc('fn_admin_cat_by_id', { p_id: p.categoria_id });
        const o=document.createElement('option'); o.value=subId; o.textContent=sc?.nombre||`ID ${subId}`; sub.appendChild(o);
      }
      sub.value=subId;
      if(p.imagen_url){ prev.src=p.imagen_url; prev.classList.remove('hidden'); document.getElementById('p-prev-ph').classList.add('hidden'); }
    } else {
      title.textContent='Nuevo Producto';
      name.value=''; desc.value=''; precio.value=''; stock.value=''; fileIn.value=''; sub.value = sub.value || '';
    }
  }
  function closeProdModal(){ document.getElementById('prod-modal').classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
  document.getElementById('btn-new').addEventListener('click', ()=>openProdModal(null));
  document.getElementById('pm-close').addEventListener('click', closeProdModal);
  document.getElementById('p-cancel').addEventListener('click', closeProdModal);
  // Preview y quitar imagen
  const fileIn=document.getElementById('p-file');
  const prev=document.getElementById('p-preview');
  const ph=document.getElementById('p-prev-ph');
  document.getElementById('p-change-img').addEventListener('click', ()=> fileIn.click());
  fileIn.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f){ prodRemoveImg=false; prev.src=URL.createObjectURL(f); prev.classList.remove('hidden'); ph.classList.add('hidden'); }});
  document.getElementById('p-remove-img').addEventListener('click', ()=>{ prev.removeAttribute('src'); prev.classList.add('hidden'); ph.classList.remove('hidden'); fileIn.value=''; prodRemoveImg=true; });
  document.getElementById('p-save').addEventListener('click', async ()=>{
    const name=document.getElementById('p-nombre').value.trim();
    if(!name){ alert('Nombre es obligatorio'); return; }
    const descripcion=document.getElementById('p-desc').value.trim()||null;
    const precio=Number(document.getElementById('p-precio').value||0);
    const stock=Number(document.getElementById('p-stock').value||0);
    const categoria_id=Number(document.getElementById('p-sub').value);
    let imagen_url=null; const f=document.getElementById('p-file').files[0];
    if(f){ const path=`productos/${Date.now()}-${f.name.replace(/[^a-zA-Z0-9.\-_]/g,'_')}`; const { error:upErr }=await supabaseClient.storage.from('imagenes').upload(path, f, {contentType:f.type, upsert:true}); if(upErr){ alert(upErr.message||'No se pudo subir la imagen'); return; } const pub=supabaseClient.storage.from('imagenes').getPublicUrl(path); imagen_url=pub.data.publicUrl||null; }
    // Usar RPC con SECURITY DEFINER para evitar problemas de RLS al guardar
    const rpcPayload = {
      p_id: editingProductId ?? null,
      p_nombre: name,
      p_descripcion: descripcion,
      p_precio: precio,
      p_stock: stock,
      p_categoria_id: categoria_id || null,
      p_imagen_url: imagen_url,
      p_remove_img: prodRemoveImg
    };
    const { error } = await supabaseClient.rpc('fn_admin_save_product', rpcPayload);
    if(error){
      if(error.code==='23505'){ alert('Ya existe un producto con ese nombre en esta subcategor√≠a.'); }
      else { alert(error.message||'No se pudo guardar'); }
      return;
    }
    // limpiar y cerrar
    ['p-nombre','p-desc','p-precio','p-stock'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('p-file').value='';
    const _prev=document.getElementById('p-preview'); const _ph=document.getElementById('p-prev-ph'); _prev.removeAttribute('src'); _prev.classList.add('hidden'); _ph.classList.remove('hidden');
    closeProdModal();
    loadProducts();
  });
}
window.addEventListener('DOMContentLoaded', async()=>{
  if(await requireAdmin()){
    await loadFilters();
    await loadProducts();
    bind();
    document.getElementById('btn-admin-logout')?.addEventListener('click', Auth.signOut);
    // Cerrar lightbox al hacer clic en fondo o en el bot√≥n de cerrar
    const overlay=document.getElementById('img-lightbox');
    const img=document.getElementById('img-lightbox-img');
    const closeBtn=document.getElementById('img-lightbox-close');
    function hideLightbox(){
      if(overlay){ overlay.classList.add('hidden'); }
      if(img){ img.removeAttribute('src'); }
      document.body.classList.remove('overflow-hidden');
    }
    overlay?.addEventListener('click', (e)=>{ if(e.target===overlay){ hideLightbox(); }});
    closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); hideLightbox(); });
  }
});
</script>
</div>
<!-- Lightbox para imagen de producto -->
<div id="img-lightbox" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm flex items-center justify-center">
  <div class="relative max-w-3xl max-h-[90vh] w-full px-4">
    <button id="img-lightbox-close" class="absolute -top-3 right-4 h-8 w-8 rounded-full bg-white/90 hover:bg-white shadow flex items-center justify-center text-gray-700">
      <span class="material-symbols-outlined text-base">close</span>
    </button>
    <img id="img-lightbox-img" alt="Imagen de producto" class="w-full max-h-[90vh] rounded-2xl bg-white shadow-2xl border object-contain"/>
  </div>
</div>
</body></html>
