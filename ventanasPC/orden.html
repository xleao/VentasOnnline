<!DOCTYPE html>
<html class="light" lang="es"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Detalle de Orden - Makitu Store</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#e6994c","background-light":"#f8f7f6","background-dark":"#211911","brand-primary":"#D4B996","brand-secondary":"#A0765E","brand-background":"#FAF8F5","brand-warning":"#E7C8A0"},fontFamily:{display:["Plus Jakarta Sans","sans-serif"]},borderRadius:{DEFAULT:"0.5rem",lg:"1rem",xl:"1.5rem",full:"9999px"}}}}</script>
<style>.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="assets/app.js"></script>
</head>
<body class="font-display bg-brand-background dark:bg-background-dark text-brand-secondary dark:text-background-light">
<div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
<main class="container mx-auto px-4 py-8 md:py-12">
<div class="max-w-5xl mx-auto flex flex-col gap-8">
<div class="flex flex-wrap justify-between items-start gap-4">
<div class="flex min-w-72 flex-col gap-2">
  <p class="text-3xl md:text-4xl font-black">Detalle de tu Orden</p>
  <div class="flex items-center gap-3">
    <span id="o-mp-badge" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-800"></span>
    <div class="flex items-center gap-2"><div id="o-status-dot" class="w-2 h-2 rounded-full bg-brand-warning"></div><p id="o-status" class="text-base">Pendiente</p></div>
  </div>
</div>
</div>
<div class="bg-white dark:bg-background-dark/50 rounded-xl border p-6 shadow-sm">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
<div class="flex flex-col gap-2"><p class="text-base">Monto Total</p><p id="o-total" class="text-2xl font-bold">S/ 0.00</p></div>
<div class="flex flex-col gap-2"><p class="text-base">Fecha de Vencimiento</p><p id="o-vence" class="text-2xl font-bold">-</p></div>
<div class="col-span-1 md:col-span-2 lg:col-span-2">
<p class="text-base mb-2">Tiempo restante para pagar:</p>
<div id="timer" class="flex gap-2 md:gap-4"></div>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-1">
  <div id="pay-panel" class="flex flex-col rounded-xl shadow-sm bg-white dark:bg-background-dark/50 p-6 border"></div>
</div>
<div class="lg:col-span-2">
<div class="bg-white dark:bg-background-dark/50 rounded-xl border shadow-sm">
<div class="p-6 border-b"><h3 class="text-lg font-bold">Ítems en tu Orden</h3></div>
<div id="o-items" class="flex flex-col divide-y"></div>
<div class="p-4 flex justify-end"><div class="text-right"><p class="text-sm">Subtotal: <span id="o-subtotal">S/ 0.00</span></p><p class="text-sm">Envío: S/ 0.00</p><p class="text-lg font-bold mt-1">Total: <span id="o-total2">S/ 0.00</span></p></div></div>
</div>
<div id="o-actions" class="mt-4"></div>
</div>
</div>
<div class="flex justify-center mt-4">
<a href="mis-ordenes.html" class="flex items-center gap-2 min-w-[84px] justify-center rounded-lg h-10 px-4 text-sm font-bold border-2 border-brand-primary hover:bg-brand-primary/10"><span class="material-symbols-outlined text-base">arrow_back</span><span>Regresar a Mis Órdenes</span></a>
</div>
</div>
</main>
</div>
<script>
function pad(n){return String(n).padStart(2,'0')}
function setTimerTo(venceEn, ordenId, metodoPago, estadoInicial){
  const c = document.getElementById('timer');
  const end = new Date(venceEn).getTime();
  let fired = false;
  function tick(){
    const left = Math.max(0, end - Date.now());
    const s = Math.floor(left/1000), m = Math.floor(s/60)%60, h=Math.floor(s/3600)%24, d=Math.floor(s/86400);
    c.innerHTML = [d,h,m,Math.floor(s%60)].map((val,idx)=>`<div class='flex-1 flex flex-col gap-2'><div class='flex h-14 items-center justify-center rounded-lg bg-brand-background'><p class='text-lg font-bold'>${pad(val)}</p></div><div class='flex items-center justify-center'><p class='text-sm'>${['Días','Horas','Min','Seg'][idx]}</p></div></div>`).join('');
    if(left<=0){
      clearInterval(int);
      // Si vence y era YAPE y no estaba ya en estado final, llamar RPC para expirar y devolver stock
      const est = String(estadoInicial||'').toLowerCase();
      const final = ['confirmada','entregada','cancelada','expirada'];
      const onceKey = `expired_called_${ordenId}`;
      if(!fired && metodoPago === 'YAPE' && final.indexOf(est) === -1 && !sessionStorage.getItem(onceKey)){
        fired = true;
        sessionStorage.setItem(onceKey, '1');
        supabaseClient.rpc('fn_expire_yape_order', { p_orden_id: ordenId })
          .then(()=>{
            // actualizar UI localmente a Expirada, sin recargar
            const stDot = document.getElementById('o-status-dot');
            const stTxt = document.getElementById('o-status');
            if(stDot) stDot.className = 'w-2 h-2 rounded-full bg-red-500';
            if(stTxt) stTxt.textContent = 'Expirada';
          })
          .catch(()=>{/* ignorar */});
      }
    }
  }
  const int = setInterval(tick, 1000); tick();
}
function s(n){ return `S/ ${(n||0).toFixed(2)}` }
async function loadOrder(){
  // Si no se proporciona id, intenta traer la última orden del usuario
  let id = Number(window.qsParam?.('id'));
  if(!id){
    const s = await Auth.getSession();
    const uid = s?.user?.id;
    if(!uid){ document.getElementById('o-items').innerHTML = `<div class='p-4 text-center'>Inicia sesión para ver tus órdenes</div>`; return; }
    const { data:last, error:le } = await supabaseClient.from('ordenes').select('id').eq('usuario_id', uid).order('id', { ascending:false }).limit(1).maybeSingle();
    if(le || !last){ document.getElementById('o-items').innerHTML = `<div class='p-4 text-center'>No tienes órdenes</div>`; return; }
    id = last.id;
    history.replaceState(null, '', `orden.html?id=${id}`);
  }
  // Orden
  const { data:orden, error:oerr } = await supabaseClient.from('ordenes').select('*').eq('id', id).single();
  if(oerr){ document.getElementById('o-items').innerHTML = `<div class='p-4 text-center'>No se pudo cargar la orden</div>`; return; }
  document.getElementById('o-total').textContent = s(Number(orden.total)||0);
  document.getElementById('o-total2').textContent = s(Number(orden.total)||0);
  document.getElementById('o-vence').textContent = orden.vence_en ? new Date(orden.vence_en).toLocaleString() : '-';
  // Cabecera: método de pago y estado
  const mpBadge = document.getElementById('o-mp-badge');
  if(mpBadge){
    const isCash = orden.metodo_pago === 'EFECTIVO';
    mpBadge.textContent = isCash ? 'Efectivo' : 'Yape';
    mpBadge.className = `text-xs px-2 py-1 rounded-full ${isCash?'bg-gray-200 text-gray-800':'bg-purple-200 text-purple-800'}`;
  }
  const stDot = document.getElementById('o-status-dot');
  const stTxt = document.getElementById('o-status');
  const nowMs = Date.now();
  const vencio = (orden.metodo_pago === 'YAPE') && orden.vence_en && (new Date(orden.vence_en).getTime() < nowMs);
  const est = (orden.estado||'').toLowerCase();
  let statusLabel = 'Pendiente';
  let dotClass = 'bg-brand-warning';
  if(est === 'confirmada') { statusLabel = 'Confirmada'; dotClass = 'bg-blue-600'; }
  else if(est === 'entregada') { statusLabel = 'Entregada'; dotClass = 'bg-green-600'; }
  else if(est === 'expirada' || vencio) { statusLabel = 'Expirada'; dotClass = 'bg-red-500'; }
  if(stDot) stDot.className = `w-2 h-2 rounded-full ${dotClass}`;
  if(stTxt) stTxt.textContent = statusLabel;
  if(orden.metodo_pago === 'EFECTIVO'){
    // ocultar fecha de vencimiento y contador
    const venceBlock = document.getElementById('o-vence')?.parentElement;
    if(venceBlock) venceBlock.style.display = 'none';
    const timerBlock = document.getElementById('timer')?.parentElement;
    if(timerBlock) timerBlock.style.display = 'none';
  } else {
    const timerEl = document.getElementById('timer');
    // Si ya está expirada o vencida, mostrar 00:00 directamente y no iniciar timer
    if(est === 'expirada' || vencio){
      if(timerEl){
        const vals = [0,0,0,0];
        timerEl.innerHTML = vals.map((val,idx)=>`<div class='flex-1 flex flex-col gap-2'><div class='flex h-14 items-center justify-center rounded-lg bg-brand-background'><p class='text-lg font-bold'>${pad(val)}</p></div><div class='flex items-center justify-center'><p class='text-sm'>${['Días','Horas','Min','Seg'][idx]}</p></div></div>`).join('');
      }
    } else if(orden.vence_en){
      // Orden YAPE activa: iniciar contador normal
      setTimerTo(orden.vence_en, id, orden.metodo_pago, orden.estado);
    }
  }
  // Panel de pago
  const pay = document.getElementById('pay-panel');
  if(orden.metodo_pago === 'YAPE'){
    pay.innerHTML = `
      <div class="flex w-full grow flex-col gap-4">
        <div><p class="text-lg font-bold">¡Paga fácil con Yape!</p><p class="text-sm">Escanea este código QR</p></div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 aspect-square rounded-lg flex items-center justify-center"><span class="material-symbols-outlined text-5xl text-gray-400">qr_code_2</span></div>
        <p class="text-sm">Abre tu app Yape, escanea el código y realiza el pago. Envía el comprobante.</p>
      </div>`;
  } else {
    pay.innerHTML = `
      <div class="flex w-full grow flex-col gap-4">
        <div><p class="text-lg font-bold">Pago en efectivo (contraentrega)</p><p class="text-sm">Entrega en la UNI</p></div>
        <div class="w-full rounded-lg bg-gray-100 dark:bg-gray-800 p-4">
          <p class="text-sm">Hemos registrado tu pedido. Escríbenos por WhatsApp al <span class="font-bold">943 836 076</span> para coordinar el lugar exacto de entrega en la UNI.</p>
          <p class="text-sm mt-2">Tu orden quedará confirmada cuando el administrador la marque como confirmada.</p>
        </div>
      </div>`;
  }
  // Ítems
  const { data:items, error:ierr } = await supabaseClient.from('orden_items').select('*').eq('orden_id', id).order('id', { ascending: true });
  const list = document.getElementById('o-items');
  if(ierr){ list.innerHTML = `<div class='p-4 text-center'>No se pudieron cargar los ítems</div>`; return; }
  if(!items || items.length===0){ list.innerHTML = `<div class='p-4 text-center'>Sin ítems</div>`; return; }
  // Completar imagen_url desde productos si no viene en los ítems
  let withImgs = items.slice();
  try{
    const missing = withImgs.filter(x=>!x.imagen_url).map(x=>x.producto_id).filter((v,i,a)=>a.indexOf(v)===i);
    if(missing.length){
      const { data:prods } = await supabaseClient.from('productos').select('id, imagen_url').in('id', missing);
      const map = Object.fromEntries((prods||[]).map(p=>[String(p.id), p.imagen_url||'']));
      withImgs = withImgs.map(x=>({ ...x, imagen_url: x.imagen_url || map[String(x.producto_id)] || '' }));
    }
  }catch{}
  list.innerHTML = withImgs.map(it=>`<div class='flex items-center gap-4 p-4'>
    <img class='w-16 h-16 rounded-md object-cover bg-gray-100' src='${it.imagen_url||''}' alt='${it.producto_nombre||""}'/>
    <div class='flex-grow'><p class='font-bold'>${it.producto_nombre||''}</p><p class='text-sm'>Cantidad: ${it.cantidad}</p></div>
    <p class='font-bold'>${s((Number(it.precio_unitario)||0)*(it.cantidad||0))}</p>
  </div>`).join('');
  const subtotal = items.reduce((a,b)=> a + (Number(b.subtotal) || (Number(b.precio_unitario)||0)*(b.cantidad||0)), 0);
  document.getElementById('o-subtotal').textContent = s(subtotal);
  document.getElementById('o-total2').textContent = s(Number(orden.total)||subtotal);

  // Volver a pedir si está expirada
  const now = Date.now();
  const expirada = (orden.estado === 'expirada') || (orden.metodo_pago === 'YAPE' && orden.vence_en && (new Date(orden.vence_en).getTime() < now));
  if(expirada){
    const actions = document.getElementById('o-actions');
    actions.innerHTML = `<button id="btn-reorder" class="flex items-center gap-2 min-w-[140px] justify-center rounded-lg h-10 px-4 text-sm font-bold bg-primary text-white hover:bg-opacity-90"><span class="material-symbols-outlined text-base">shopping_bag</span><span>Volver a pedir</span></button>`;
    document.getElementById('btn-reorder')?.addEventListener('click', ()=>{
      try{
        withImgs.forEach(it=>{
          Cart.add({ producto_id: it.producto_id, nombre: it.producto_nombre, precio_unitario: Number(it.precio_unitario)||0, imagen_url: it.imagen_url||'', cantidad: it.cantidad||1 });
        });
        location.href = 'carrito.html';
      }catch(e){ console.error(e); }
    });
  }
  // Cancelar orden si es EFECTIVO y está pendiente
  const pendiente = !expirada && (['pagada','confirmada'].indexOf((orden.estado||'').toLowerCase()) === -1);
  if(orden.metodo_pago === 'EFECTIVO' && pendiente){
    const actions = document.getElementById('o-actions');
    const btnId = 'btn-cancel-order';
    const existing = actions.innerHTML;
    actions.innerHTML = `${existing || ''}<button id="${btnId}" class="ml-0 mt-3 inline-flex items-center gap-2 min-w-[140px] justify-center rounded-lg h-10 px-4 text-sm font-bold border-2 border-red-400 text-red-600 hover:bg-red-50"><span class="material-symbols-outlined text-base">cancel</span><span>Cancelar orden</span></button>`;
    document.getElementById(btnId)?.addEventListener('click', async ()=>{
      if(!confirm('¿Cancelar esta orden? Se devolverá el stock.')) return;
      try{
        const { error } = await supabaseClient.rpc('fn_cancel_my_order', { p_orden_id: id });
        if(error){ alert(error.message||'No se pudo cancelar'); return; }
        location.reload();
      }catch(e){ alert('No se pudo cancelar'); }
    });
  }
}
window.addEventListener('DOMContentLoaded', async ()=>{
  const ok = await Auth.requireAuth();
  if(!ok) return;
  loadOrder();
});
</script>
</body></html>
